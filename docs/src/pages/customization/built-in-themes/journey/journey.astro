---
import {
  getStaticPathsForThemeFactory,
  type Props,
} from "astro-spaceship/components/Article/utils/_get-static-paths-for-theme.ts";
import Page from "astro-spaceship/components/Article/Page.astro";

import CoverImage from "astro-spaceship/components/Article/CoverImage.astro";
import Tags from "astro-spaceship/components/Article/Tags.astro";
import ArticleDate from "astro-spaceship/components/Article/Date.astro";
import Author from "astro-spaceship/components/Article/Author.astro";
import Title from "astro-spaceship/components/Article/Title.astro";
import Subtitle from "astro-spaceship/components/Article/Subtitle.astro";
import Description from "astro-spaceship/components/Article/Description.astro";
import TextReader from "astro-spaceship/components/Article/TextReader/TextReader.astro";
import config from "astro-spaceship/config";

import "@/styles/themes/journey.css";
import { render } from "astro:content";

const getStaticPathsForThemePage = getStaticPathsForThemeFactory({ config });

const staticPath = await getStaticPathsForThemePage("journey");

if (!staticPath) {
  return Astro.redirect("404");
}

const {
  author,
  document,
  tags,
} = staticPath.props;

// biome-ignore lint/suspicious/noExplicitAny: <explanation>
const { Content } = await render(document as any);

const showMetaSection =
  config.displayOptions?.showAuthor !== false ||
  config.displayOptions?.showPublishDate !== false ||
  tags.length > 0;

const showDescriptionSection = !!document.data.description;


const hash = (str: string) => {
  let h = 5381;
  for (let i = 0; i < str.length; i++) h = ((h << 5) + h) ^ str.charCodeAt(i);
  // fuerza a unsigned 32-bit
  return h >>> 0;
};

const angleFromKey = (key: string, min = -3, max = 3) => {
  const h = hash(key);
  const t = h / 0xffffffff; // 0..1
  return min + t * (max - min);
};

const { data } = document;
---

<Page {...staticPath.props} config={{
  ...config,
  title: 'Journey',
  logo: "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><g fill='none' stroke='currentColor' stroke-width='1.5'><path d='M17 22h5V4.5L19.5 2L17 4.5zm0-5h5M14 2H2v20h12'/><path d='M6 6h7.5v4H6z'/></g></svg>",
  displayOptions: {
    ...config.displayOptions,
    rightSidebar: {
      mode: 'column'
    }
  }
}}>
  <Fragment slot="head">
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="https://cdn.jsdelivr.net/fontsource/fonts/dancing-script:vf@latest/latin-wght-normal.woff2"
      crossorigin="anonymous"
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="https://cdn.jsdelivr.net/fontsource/fonts/gloria-hallelujah@latest/latin-400-normal.woff2"
      crossorigin="anonymous"
    />
  </Fragment>
  <article slot="entry" class="article" data-pagefind-body>
    <section class:list={["article-content", ...(data.cssClass ?? []), ...(data.cssclasses ?? [])]}>
      <Title document={document} />
      <Subtitle document={document} />
      {
        showDescriptionSection && (
          <div class="article-description-section">
            <Description document={document} />
          </div>
        )
      }
      {data.cover && (
        <CoverImage {...data} style={`--rot:${angleFromKey(data.cover.src).toFixed(2)}deg;`}>
          <span slot="figcaption" class="gloss" aria-hidden="true"></span>
        </CoverImage>
      )}
      <div class="article-reader">
        <TextReader />
      </div>
      <div data-pagefind-weight="0.1" class="article-body">
        <Content />
        {showDescriptionSection && (<hr>)}
      </div>
      {
        showDescriptionSection && (
          <div class="article-description-section">
            {showMetaSection && (
              <div class="article-meta">
                <Author config={config} author={author} />
                <ArticleDate config={config} document={document} />     
                <Tags tags={tags} />
              </div>
            )}
          </div>
        )
      }
    </section>
  </article>
</Page>
